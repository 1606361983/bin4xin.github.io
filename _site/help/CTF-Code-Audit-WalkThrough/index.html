<!DOCTYPE html>
<html>
<style>
.navbar-hide{
	display: none;
}
</style>
	<head>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="© 关于哨兵，这是一个与哨兵安全相关的简述。">
<meta name="keywords" content="网络安全,哨兵安全,Cyber Security,Open Source">
<meta name="author" content="Sentry Security">
<link rel="shortcut icon" href="/static/img/favicon.png">
<title> CTF - 代码审计向  © 关于哨兵 | 哨兵安全实验室</title>
<!--<base target="_blank" />-->
<link rel="stylesheet" href="/static/css/bootstrap.css">
<link rel="stylesheet" href="/static/css/bootstrap-select.min.css">
<link rel="stylesheet" href="/static/css/font-awesome.min.css" >
<link rel="stylesheet" href="/static/css/spinkit.css">
<link rel="stylesheet" href="/static/css/style.css">
<link rel="stylesheet" type="text/css" href="/static/css/pace-minimal.css">

<script src="/static/js/jquery.min.js"></script>
<!--jquery sticky js source files add-->
<script src="/static/js/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.sticky/1.0.4/jquery.sticky.js"></script>
<!--jquery sticky js source files add stop-->
<script src="/static/js/bootstrap.min.js"></script>
<script src="/static/js/bootstrap-select.min.js"></script>
<script src="/static/js/pace.min.js"></script>

<!--start-->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
        inlineMath: [['$$','$$']]
      }
    });
  </script>
<script src="/static/js/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
<!--https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js shuxue gongshi. stop-->

<script src="/static/js/vue.min.js"></script>
<script src="/static/js/timeago.min.js"></script>

<script src="/static/js/markup.min.js"></script>
<script src="/static/js/webfont.js"></script>
<script src="/static/js/thuhidden.js"></script>

</head>

<body>
	<div class="navbar navbar-default" role="navigation">
  <div class="container">
    <div class="navbar-header">
      
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
			<a class="navbar-brand" href="/">
				<span class="thuhidden">
					
					<picture>
						
						<source 
						
							srcset="/static/img/logo-small-dark.png 1x,
											/static/img/logo-small-dark@2x.png 2x,
											/static/img/logo-small-dark@3x.png 3x,
											/static/img/logo-small-dark@4x.png 4x"
						
							media="(prefers-color-scheme: dark)"/>
						
						
						<img src="/static/img/logo-small.png" 
							srcset="/static/img/logo-small.png 1x, 
											/static/img/logo-small@2x.png 2x, 
											/static/img/logo-small@3x.png 3x, 
											/static/img/logo-small@4x.png 4x"
							alt=""/>
						
					</picture>
					
					</span>关于我的一些自述
			</a>
    </div>
    <div class="navbar-collapse collapse navbar-right">
      <ul class="nav navbar-nav" role="menubar">
        
        
        <li role="none"><a role="menuitem" href="https://www.sentrylab.cn">HOME</a></li>
        <li role="none"><a role="menuitem" href="https://www.sentrylab.cn/blog">BLOG</a></li>
        <li role="none"><a role="menuitem" href="https://www.sentrylab.cn/events">EVENT</a></li>
        <li role="none"><a role="menuitem" href="https://www.sentrylab.cn/categories">CATEGORIES</a></li>
        <li role="none"><a role="menuitem" href="https://www.sentrylab.cn/daily">DAILY</a></li>
        <li class="active"><a href="/">ABOUT ME</a></li>

        
       
      </ul>
    </div><!--/.nav-collapse -->
  </div>
</div>




<script>
	window.mirrorId = "CTF - 代码审计向";
</script>


<div id="help-page">
	<div class="container">
	  <div class="row">
		  <div class="col-sm-3 hidden-xs">
				<ul class="nav nav-pills nav-stacked" id="help-nav">
					
					<li id="toc-ATT&CK - 基于 scylla 的访问代理池"><a href="/help/Thousand-people-Thousand-faces-Red-team-penetration-agent-pool-based-on-scylla/"><code-index-css>ATT&CK - 基于 scylla 的访问代理池</code-index-css></a></li>
					
					<li class="active" id="toc-CTF - 代码审计向"><a href="/help/CTF-Code-Audit-WalkThrough/"><code-index-css>CTF - 代码审计向</code-index-css></a></li>
					
					<li id="toc-CTF - 密码学与杂项"><a href="/help/CTF-Crypto-and-Misc-etc-WalkThrough/"><code-index-css>CTF - 密码学与杂项</code-index-css></a></li>
					
					<li id="toc-Dynamic-analysis-of-java-framework-code"><a href="/help/Dynamic-analysis-of-java-framework-code/"><code-index-css>Dynamic-analysis-of-java-framework-code</code-index-css></a></li>
					
					<li id="toc-Hikvision-ConfigurationFiles-decrypter"><a href="/help/Hikvision-ConfigurationFiles-decrypter/"><code-index-css>Hikvision-ConfigurationFiles-decrypter</code-index-css></a></li>
					
					<li id="toc-JRMP-Gadget"><a href="/help/JRMP-Gadget/"><code-index-css>JRMP-Gadget</code-index-css></a></li>
					
					<li id="toc-Mod-Waf-Bypass-Walkthrough"><a href="/help/Mod-Waf-Bypass-Walkthrough/"><code-index-css>Mod-Waf-Bypass-Walkthrough</code-index-css></a></li>
					
					<li id="toc-ModSec & CloudFlare WAF Initial Research"><a href="/help/WAF-developed-by-Grayscale-forwarding/"><code-index-css>ModSec & CloudFlare WAF Initial Research</code-index-css></a></li>
					
					<li id="toc-Router-BinFile-Analysis"><a href="/help/Router-BinFile-Analysis/"><code-index-css>Router-BinFile-Analysis</code-index-css></a></li>
					
					<li id="toc-SQL注入原理分析"><a href="/help/ALL-SQL-INJECTION-ANALYSIS/"><code-index-css>SQL注入原理分析</code-index-css></a></li>
					
					<li id="toc-ShiroDeser"><a href="/help/ShiroDeser/"><code-index-css>ShiroDeser</code-index-css></a></li>
					
					<li id="toc-SpringBoot-Memory-files-heapdump-Analysis"><a href="/help/SpringBoot-Memory-files-heapdump-Analysis/"><code-index-css>SpringBoot-Memory-files-heapdump-Analysis</code-index-css></a></li>
					
					<li id="toc-Struts2Deser"><a href="/help/Struts2Deser/"><code-index-css>Struts2Deser</code-index-css></a></li>
					
					<li id="toc-javaDeser"><a href="/help/javaDeser/"><code-index-css>javaDeser</code-index-css></a></li>
					
					<li id="toc-polkit-CVE-2021-3560"><a href="/help/polkit-CVE-2021-3560/"><code-index-css>polkit-CVE-2021-3560</code-index-css></a></li>
					
					<li id="toc-基于内存的Shiro框架Webshell攻击研究"><a href="/help/Research-on-Webshell-Attack-of-Shiro-Framework-Based-on-Memory/"><code-index-css>基于内存的Shiro框架Webshell攻击研究</code-index-css></a></li>
					
					<li id="toc-安全与开发之：Maven构建排错"><a href="/help/ALL-mvn-build-errors/"><code-index-css>安全与开发之：Maven构建排错</code-index-css></a></li>
					
					<li id="toc-浪潮ClusterEngineV4.0代码审计历程"><a href="/help/inspur-Cluster-Engine-V4.0-code-aduit-walkthrough/"><code-index-css>浪潮ClusterEngineV4.0代码审计历程</code-index-css></a></li>
					
					<li id="toc-通达OA利用代码分析"><a href="/help/ToDa-OA-VulnPoc-by-java-analysis/"><code-index-css>通达OA利用代码分析</code-index-css></a></li>
					
				</ul>
				
				
				<div id="sticky-wrapper" class="sticky-wrapper" style="height: 200px;">
					<li class="nav nav-pills nav-stacked" id="help-nav">
						<code-index-css>
							<details open class="article-index" style="overflow: visible;">
								<summary class="point">文章目录&nbsp &nbsp</summary>
								<div class="hline"></div>
								<div class="spacing"></div>
								<ul id="toc" class="section-nav">
<li class="toc-entry toc-h1"><a href="#零web">零：WEB</a>
<ul>
<li class="toc-entry toc-h4"><a href="#-0x01-任意文件读取绕过"># 0x01 任意文件读取绕过</a></li>
<li class="toc-entry toc-h4"><a href="#-0x02-nannannannan-batman奇妙的js"># 0x02 NaNNaNNaNNaN-Batman：奇妙的js</a></li>
<li class="toc-entry toc-h4"><a href="#-0x03-php伪协议"># 0x03 php伪协议</a></li>
<li class="toc-entry toc-h4"><a href="#-0x03-卖瓜"># 0x03 卖瓜</a></li>
</ul>
</li>
</ul>
							</details>
						</code-index-css>
					</li>
				</div>
				 


				<!--click this icon -> scroll to top of page; code from anquanke. also this icon func are under-construction-->		
				<!-- <div class="back-to-top" onclick="$(&quot;html,body&quot;).animate({scrollTop:0}, 500);" style="position: fixed;bottom:400px;right: 20px;height: 40px;width: 40px;background-color: #1dada7;border-radius: 50%;text-align: center;cursor: pointer">
					<img src="https://p0.ssl.qhimg.com/t0179ac3294ef926b8c.png" style="width:30px;margin-top: 6px;">
				</div> -->


			</div><!-- sidenave -->
			<div class="col-sm-9">
				<div class="visible-xs">
					<form class="form-inline">
						<div class="form-group">
							<label>选择: </label>
							<select class="form-control" id="help-select">
								
								<option data-help-url="/help/Thousand-people-Thousand-faces-Red-team-penetration-agent-pool-based-on-scylla/" id="toc-ATT&CK - 基于 scylla 的访问代理池">ATT&CK - 基于 scylla 的访问代理池</option>
								
								<option data-help-url="/help/CTF-Code-Audit-WalkThrough/" selected id="toc-CTF - 代码审计向">CTF - 代码审计向</option>
								
								<option data-help-url="/help/CTF-Crypto-and-Misc-etc-WalkThrough/" id="toc-CTF - 密码学与杂项">CTF - 密码学与杂项</option>
								
								<option data-help-url="/help/Dynamic-analysis-of-java-framework-code/" id="toc-Dynamic-analysis-of-java-framework-code">Dynamic-analysis-of-java-framework-code</option>
								
								<option data-help-url="/help/Hikvision-ConfigurationFiles-decrypter/" id="toc-Hikvision-ConfigurationFiles-decrypter">Hikvision-ConfigurationFiles-decrypter</option>
								
								<option data-help-url="/help/JRMP-Gadget/" id="toc-JRMP-Gadget">JRMP-Gadget</option>
								
								<option data-help-url="/help/Mod-Waf-Bypass-Walkthrough/" id="toc-Mod-Waf-Bypass-Walkthrough">Mod-Waf-Bypass-Walkthrough</option>
								
								<option data-help-url="/help/WAF-developed-by-Grayscale-forwarding/" id="toc-ModSec & CloudFlare WAF Initial Research">ModSec & CloudFlare WAF Initial Research</option>
								
								<option data-help-url="/help/Router-BinFile-Analysis/" id="toc-Router-BinFile-Analysis">Router-BinFile-Analysis</option>
								
								<option data-help-url="/help/ALL-SQL-INJECTION-ANALYSIS/" id="toc-SQL注入原理分析">SQL注入原理分析</option>
								
								<option data-help-url="/help/ShiroDeser/" id="toc-ShiroDeser">ShiroDeser</option>
								
								<option data-help-url="/help/SpringBoot-Memory-files-heapdump-Analysis/" id="toc-SpringBoot-Memory-files-heapdump-Analysis">SpringBoot-Memory-files-heapdump-Analysis</option>
								
								<option data-help-url="/help/Struts2Deser/" id="toc-Struts2Deser">Struts2Deser</option>
								
								<option data-help-url="/help/javaDeser/" id="toc-javaDeser">javaDeser</option>
								
								<option data-help-url="/help/polkit-CVE-2021-3560/" id="toc-polkit-CVE-2021-3560">polkit-CVE-2021-3560</option>
								
								<option data-help-url="/help/Research-on-Webshell-Attack-of-Shiro-Framework-Based-on-Memory/" id="toc-基于内存的Shiro框架Webshell攻击研究">基于内存的Shiro框架Webshell攻击研究</option>
								
								<option data-help-url="/help/ALL-mvn-build-errors/" id="toc-安全与开发之：Maven构建排错">安全与开发之：Maven构建排错</option>
								
								<option data-help-url="/help/inspur-Cluster-Engine-V4.0-code-aduit-walkthrough/" id="toc-浪潮ClusterEngineV4.0代码审计历程">浪潮ClusterEngineV4.0代码审计历程</option>
								
								<option data-help-url="/help/ToDa-OA-VulnPoc-by-java-analysis/" id="toc-通达OA利用代码分析">通达OA利用代码分析</option>
								
							</select>
						</div>
					</form>
				</div>
				<div id="help-content">

				<center>
					
					<csmall>本文最后修改于：<em>2021-09-03</em></csmall>
					
				<csmall><em> | Sentry Security | 哨兵安全实验室</em></csmall>
				</center>

					<div class="hline"></div>
					<div class="spacing"></div>

					<h1 id="零web">零：WEB</h1>

<h4 id="-0x01-任意文件读取绕过"># 0x01 任意文件读取绕过</h4>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="nb">highlight_file</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">);</span>
<span class="kd">class</span> <span class="nc">emmm</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="n">checkFile</span><span class="p">(</span><span class="o">&amp;</span><span class="nv">$page</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$whitelist</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"source"</span><span class="o">=&gt;</span><span class="s2">"source.php"</span><span class="p">,</span><span class="s2">"hint"</span><span class="o">=&gt;</span><span class="s2">"hint.php"</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="k">isset</span><span class="p">(</span><span class="nv">$page</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_string</span><span class="p">(</span><span class="nv">$page</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s2">"you can't see it"</span><span class="p">;</span>
            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$page</span><span class="p">,</span> <span class="nv">$whitelist</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$_page</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span>
            <span class="nv">$page</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="nb">mb_strpos</span><span class="p">(</span><span class="nv">$page</span> <span class="mf">.</span> <span class="s1">'?'</span><span class="p">,</span> <span class="s1">'?'</span><span class="p">)</span>
        <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$_page</span><span class="p">,</span> <span class="nv">$whitelist</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$_page</span> <span class="o">=</span> <span class="nb">urldecode</span><span class="p">(</span><span class="nv">$page</span><span class="p">);</span>
        <span class="nv">$_page</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span>
            <span class="nv">$_page</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="nb">mb_strpos</span><span class="p">(</span><span class="nv">$_page</span> <span class="mf">.</span> <span class="s1">'?'</span><span class="p">,</span> <span class="s1">'?'</span><span class="p">)</span>
        <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$_page</span><span class="p">,</span> <span class="nv">$whitelist</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">echo</span> <span class="s2">"you can't see it"</span><span class="p">;</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="nb">empty</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'file'</span><span class="p">])</span>
    <span class="o">&amp;&amp;</span> <span class="nb">is_string</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'file'</span><span class="p">])</span>
    <span class="o">&amp;&amp;</span> <span class="n">emmm</span><span class="o">::</span><span class="nf">checkFile</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'file'</span><span class="p">])</span>
<span class="p">)</span> <span class="p">{</span>
    <span class="k">include</span> <span class="nv">$_REQUEST</span><span class="p">[</span><span class="s1">'file'</span><span class="p">];</span>
    <span class="k">exit</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">"&lt;br&gt;&lt;img src=</span><span class="se">\"</span><span class="s2">https://i.loli.net/2018/11/01/5bdb0d93dc794.jpg</span><span class="se">\"</span><span class="s2"> /&gt;"</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">?&gt;</span> 
</code></pre></div></div>
<p>先看if判断主逻辑，同时满足下列三个条件即可：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">if (! empty($_REQUEST['file'])</code>
    <ul>
      <li>传入file参数不为空，不多说；</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">&amp;&amp; is_string($_REQUEST['file'])</code>
    <ul>
      <li>传入file参数是字符串；</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">&amp;&amp; emmm::checkFile($_REQUEST['file']))</code>
    <ul>
      <li>传入file参数满足<code class="language-plaintext highlighter-rouge">emmm类的checkFile函数</code>，主要看这个函数，传入checkFile函数的file参数被重新接受为page参数，判断参数是否为空、是否为字符串，是则往下：
        <ul>
          <li>1.检查$page在不在数组$whitelist里<code class="language-plaintext highlighter-rouge">$whitelist = ["source"=&gt;"source.php","hint"=&gt;"hint.php"]; if (in_array($page, $whitelist)) {return true;}</code>：
            <ul>
              <li>即：传入参数file<code class="language-plaintext highlighter-rouge">file=source(.php) / file=hint(.php)</code> ；</li>
            </ul>
          </li>
          <li>2.对传入参数进行一次url解码</li>
          <li>3.往下；
            <div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$_page</span> <span class="o">=</span> <span class="nb">mb_substr</span><span class="p">(</span>
  <span class="nv">$page</span><span class="p">,</span>
  <span class="mi">0</span><span class="p">,</span>
  <span class="nb">mb_strpos</span><span class="p">(</span><span class="nv">$page</span> <span class="mf">.</span> <span class="s1">'?'</span><span class="p">,</span> <span class="s1">'?'</span><span class="p">)</span>
  <span class="p">);</span>
</code></pre></div>            </div>
            <ul>
              <li>先看mb_strpos，就是？在$page里第一次出现的位置再看mb_substr，只留了$page从0到？的位置；</li>
            </ul>
          </li>
          <li>4.对<code class="language-plaintext highlighter-rouge">_page</code>重复1；</li>
          <li>5.对<code class="language-plaintext highlighter-rouge">_page</code>重复2；</li>
          <li>6.对<code class="language-plaintext highlighter-rouge">_page</code>重复3；</li>
          <li>7.再次判断参数重复1；</li>
          <li>8.<code class="language-plaintext highlighter-rouge">include $_REQUEST['file'];</code></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>只要我们构造的参数满足上述步骤绕过：
<code class="language-plaintext highlighter-rouge">file=source.php%3f../../../../../../../../../../../../etc/passwd</code>，然后根据题目提示读取flag文件。</p>

<p><img src="https://i.loli.net/2021/07/29/XroGifUcBNMdsPz.png" alt="截屏2021-07-29 下午4.33.54.png" /></p>

<ul>
  <li>参考
    <ul>
      <li><a href="https://www.php.net/manual/zh/function.is-string.php" target="_blank">PHP: is_string - Manual</a></li>
      <li><a href="https://www.php.net/manual/zh/function.mb-strpos.php" target="_blank">PHP: mb_strpos - Manual</a></li>
      <li><a href="https://adworld.xctf.org.cn/task/writeup?type=web&amp;id=5442&amp;number=3&amp;grade=1&amp;page=undefined" target="_blank">XCTF - Warmup Writeup</a></li>
    </ul>
  </li>
</ul>

<h4 id="-0x02-nannannannan-batman奇妙的js"># 0x02 NaNNaNNaNNaN-Batman：奇妙的js</h4>

<p><a href="https://adworld.xctf.org.cn/media/task/attachments/646ecdf05af7490a85bb5c8ccb96c102.zip" target="_blank">NaNNaNNaNNaN-Batman附件</a>文本编辑器打开发现<code class="language-plaintext highlighter-rouge">&lt;script&gt;_='function $()</code>超文本标签，修改为html后缀，同时修改<code class="language-plaintext highlighter-rouge">eval(_)</code>为<code class="language-plaintext highlighter-rouge">alert(_)</code></p>

<p>处理后如下：</p>

<p><img src="https://i.loli.net/2021/07/29/nQH65odjRtgNeh9.png" alt="截屏2021-07-29 下午4.48.07.png" /></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">$</span><span class="p">(){</span>
    <span class="kd">var</span> <span class="nx">e</span><span class="o">=</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">c</span><span class="dl">"</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">length</span><span class="o">==</span><span class="mi">16</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^be0f23/</span><span class="p">)</span><span class="o">!=</span><span class="kc">null</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/233ac/</span><span class="p">)</span><span class="o">!=</span><span class="kc">null</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/e98aa$/</span><span class="p">)</span><span class="o">!=</span><span class="kc">null</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/c7be9/</span><span class="p">)</span><span class="o">!=</span><span class="kc">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">t</span><span class="o">=</span><span class="p">[</span><span class="dl">"</span><span class="s2">fl</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">s_a</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">i</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">e}</span><span class="dl">"</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">n</span><span class="o">=</span><span class="p">[</span><span class="dl">"</span><span class="s2">a</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">_h0l</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">n</span><span class="dl">"</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">r</span><span class="o">=</span><span class="p">[</span><span class="dl">"</span><span class="s2">g{</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">e</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">_0</span><span class="dl">"</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="p">[</span><span class="dl">"</span><span class="s2">it'</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">_</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">n</span><span class="dl">"</span><span class="p">];</span>
        <span class="kd">var</span> <span class="nx">s</span><span class="o">=</span><span class="p">[</span><span class="nx">t</span><span class="p">,</span><span class="nx">n</span><span class="p">,</span><span class="nx">r</span><span class="p">,</span><span class="nx">i</span><span class="p">];</span>
        <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">o</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="nx">o</span><span class="o">&lt;</span><span class="mi">13</span><span class="p">;</span><span class="o">++</span><span class="nx">o</span><span class="p">){</span><span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">o</span><span class="o">%</span><span class="mi">4</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span><span class="nx">s</span><span class="p">[</span><span class="nx">o</span><span class="o">%</span><span class="mi">4</span><span class="p">].</span><span class="nx">splice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="dl">'</span><span class="s1">&lt;input id="c"&gt;&lt;button onclick=$()&gt;Ok&lt;/button&gt;</span><span class="dl">'</span><span class="p">);</span>
    <span class="k">delete</span> <span class="nx">_</span>
</code></pre></div></div>
<p>根据if判断逻辑内的定义console输出：</p>

<p><img src="https://i.loli.net/2021/07/29/vSJgTNcsjDFGMoz.png" alt="截屏2021-07-29 下午4.51.36.png" /></p>

<h4 id="-0x03-php伪协议"># 0x03 php伪协议</h4>

<p>本题思路：</p>

<ul>
  <li>index.php
    <ul>
      <li>对应file参数读取文件但是过滤了关键词<code class="language-plaintext highlighter-rouge">flag</code>，同时给出关键文件<code class="language-plaintext highlighter-rouge">secure.php</code></li>
      <li><code class="language-plaintext highlighter-rouge">secure.php</code>对应输出flag的逻辑；</li>
    </ul>
  </li>
  <li>secure.php
    <ul>
      <li>尝试读取对应php文件代码：</li>
      <li>读取payload<code class="language-plaintext highlighter-rouge">index.php?file=php://filter/read=convert.base64-encode/resource=secure.php</code></li>
    </ul>
  </li>
</ul>

<p><img src="https://i.loli.net/2021/07/30/Sxo6lWYBCIpQ2tU.png" alt="截屏2021-07-29 下午2.25.57.png" /></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">secure.php</code></li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>➜ <span class="nb">echo </span>PG1ldGEgY2hhcnNldD0iVVRGLTgiPgo8P3BocAogICAgaW5jbHVkZSAnLi9mbGFnLnBocCc7CiAgICBlcnJvcl9yZXBvcnRpbmcoMCk7CiAgICAkcGFyMSA9ICRfR0VUWydwYXIxJ107CiAgICAkcGFyMiA9ICRfR0VUWydwYXIyJ107CiAgICAkcGFyMyA9ICRfUE9TVFsncGFyMyddOwogICAgJHBhcjQgPSAkX1BPU1RbJ3BhcjQnXTsKICAgIGlmIChpc3NldCgkcGFyMSkmJmlzc2V0KCRwYXIyKSYmaXNzZXQoJHBhcjMpJiZpc3NldCgkcGFyNCkpIHsKICAgICAgICBpZiAoJHBhcjEgPT09ICRwYXIyICYmIG1kNSgkcGFyMSkgIT09IG1kNSgkcGFyMikpIHsKICAgICAgICAgICAgZGllKCfov5jmg7Por7vlj5ZmbGFn77yfJyk7CiAgICAgICAgfQogICAgICAgIGlmIChoYXNoKCJtZDQiLCAkcGFyMykgPT0gaGFzaCgibWQ0IiwgJHBhcjQpKSB7CiAgICAgICAgICAgIGVjaG8gJ+e7meS9oGZsYWfvvIEnIC4gJGZsYWc7CiAgICAgICAgfQogICAgfQo<span class="o">=</span>|base64 <span class="nt">-d</span>
<span class="c">#secure.php:</span>
&lt;meta <span class="nv">charset</span><span class="o">=</span><span class="s2">"UTF-8"</span><span class="o">&gt;</span>
&lt;?php
    include <span class="s1">'./flag.php'</span><span class="p">;</span>
    error_reporting<span class="o">(</span>0<span class="o">)</span><span class="p">;</span>
    <span class="nv">$par1</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="o">[</span><span class="s1">'par1'</span><span class="o">]</span><span class="p">;</span>
    <span class="nv">$par2</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="o">[</span><span class="s1">'par2'</span><span class="o">]</span><span class="p">;</span>
    <span class="nv">$par3</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="o">[</span><span class="s1">'par3'</span><span class="o">]</span><span class="p">;</span>
    <span class="nv">$par4</span> <span class="o">=</span> <span class="nv">$_POST</span><span class="o">[</span><span class="s1">'par4'</span><span class="o">]</span><span class="p">;</span>
    <span class="k">if</span> <span class="o">(</span>isset<span class="o">(</span><span class="nv">$par1</span><span class="o">)&amp;&amp;</span>isset<span class="o">(</span><span class="nv">$par2</span><span class="o">)&amp;&amp;</span>isset<span class="o">(</span><span class="nv">$par3</span><span class="o">)&amp;&amp;</span>isset<span class="o">(</span><span class="nv">$par4</span><span class="o">))</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="nv">$par1</span> <span class="o">===</span> <span class="nv">$par2</span> <span class="o">&amp;&amp;</span> md5<span class="o">(</span><span class="nv">$par1</span><span class="o">)</span> <span class="o">!==</span> md5<span class="o">(</span><span class="nv">$par2</span><span class="o">))</span> <span class="o">{</span>
            die<span class="o">(</span><span class="s1">'还想读取flag？'</span><span class="o">)</span><span class="p">;</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="nb">hash</span><span class="o">(</span><span class="s2">"md4"</span>, <span class="nv">$par3</span><span class="o">)</span> <span class="o">==</span> <span class="nb">hash</span><span class="o">(</span><span class="s2">"md4"</span>, <span class="nv">$par4</span><span class="o">))</span> <span class="o">{</span>
            <span class="nb">echo</span> <span class="s1">'给你flag！'</span> <span class="nb">.</span> <span class="nv">$flag</span><span class="p">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</code></pre></div></div>
<p>从代码可以看到直接传入的四个参数GET：<code class="language-plaintext highlighter-rouge">par1 &amp; par2</code>，POST：<code class="language-plaintext highlighter-rouge">par3 &amp; par4</code>；</p>

<p>判断：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">if (isset($par1)&amp;&amp;isset($par2)&amp;&amp;isset($par3)&amp;&amp;isset($par4))</code>
    <ul>
      <li>设置四个参数即可；</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">if ($par1 === $par2 &amp;&amp; md5($par1) !== md5($par2)) </code>
    <ul>
      <li>与判断，直接不满足其中一个条件即可；比如让两个参数不相等或两个参数的md5
  值不相等；</li>
    </ul>
  </li>
  <li>继续往下：<code class="language-plaintext highlighter-rouge">if (hash("md4", $par3) == hash("md4", $par4))</code>
    <ul>
      <li>两个参数的md4值相等给出flag；不多说，直接上payload：</li>
    </ul>
  </li>
</ul>

<p><img src="https://i.loli.net/2021/07/30/WgMqKXGUmrxoYIv.png" alt="" /></p>

<h4 id="-0x03-卖瓜"># 0x03 卖瓜</h4>

<p>这道题对于当下的我来说还是比较难，是看了题解才做得出来；究其原因我觉得是由于代码基础太过薄弱的缘故，就拿这道题来说，就算是找到<a href="https://www.php.net/manual/zh/language.types.integer.php">PHP文档: Integer 整型</a>，下一次遇到这样的题目还是没有办法。</p>

<p>题目描述：</p>

<div><p>有一个人前来买瓜。</p>
<p>HQ：哥们，这瓜多少钱一斤啊？</p>
<p>你：两块钱一斤。</p>
<p>HQ：What's up！这瓜皮子是金子做的还是瓜粒子是金子做的？</p>
<p>你：你瞧瞧现在哪有瓜啊？这都是大棚的瓜，只有 6 斤一个和 9 斤一个的，你嫌贵我还嫌贵呢。</p>
<p>（HQ 心里默默一算）</p>
<p>HQ：给我来 20 斤的瓜。</p>
<p>你：行！</p>
<p>HQ：行？这瓜能称出 20 斤吗？</p>
<p>你：我开水果摊的，还不会称重？</p>
<p>HQ：我问你这瓜能称出 20 斤吗？</p>
<p>你：你是故意找茬，是不是？你要不要吧！</p>
<p>HQ：你这瓜要是刚好 20 斤吗我肯定要啊。那它要是没有怎么办啊？</p>
<p>你：要是不是 20 斤，我自己吃了它，满意了吧？</p>
<p>（你开始选瓜称重）</p>
<p><b style="color:red">补充说明：当称的数字变为浮点数而不是整数时，HQ 不会认可最终的称重结果。</b></p></div>

<p>题目描述看完就可以得到方程： <code class="language-plaintext highlighter-rouge">6x + 9y = 20</code> ；我的第一反应是尝试能否负数来解题；而事实上并不可以:D</p>

<p><img src="" alt="img-No-negativenumbers" /></p>

<p>实际上，题目解题思路是没有问题的，我们可以看到上面标红的补充说明，因为我们知道上面的方程x和y是没有整数解的，所以基本思路就是通过Int型与Float型的数在PHP中的转换来使的正负相加得到一个固定的数，下面来谈谈这道题；</p>

<p>我们先来整理一下关键的点：</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Server: nginx/1.21.3</code>、<code class="language-plaintext highlighter-rouge">X-Powered-By: PHP/8.0.10</code>；</li>
  <li><code class="language-plaintext highlighter-rouge">POST method: b6=1&amp;b9=1</code>，b6参数代表6斤的瓜，b9代表9斤的瓜；</li>
</ul>

<p>提出问题：</p>

<ul>
  <li>1、PHP8是否有这样的机制导致可以溢出为负整数呢？答：可以，<a href="https://www.php.net/manual/zh/language.types.integer.php">PHP文档: Integer 整型</a></li>
  <li>2、如果有的话，回到这道题上来，在没有给出代码的情况下如何利用呢？</li>
</ul>

<p>针对问题1，我参考文档给出的代码做了一些本地实验方便理解：</p>

<blockquote>
  <p>如果给定的一个数超出了 int 的范围，将会被解释为 float。同样如果执行的运算结果超出了 int 范围，也会返回 float。如下图：</p>
</blockquote>

<p><img src="https://i.loli.net/2021/11/04/6qzWEmMROCZ5TiS.png" alt="" /></p>

<blockquote>
  <p>当从浮点数 float 转换成整数 int 时，将向下取整。</p>
</blockquote>

<p>= \frac{17d-1}{2135733082216268400}</p>

\[高危率：\frac{所有高危漏洞个数（个）}{总漏洞数（个）} * 100\%  = \frac{18}{21} * 100\% = 85.71\%\]


				</div>
				<div class="spacing"></div>
	            <div>
	<div class="hline"></div>
	<h3><em>#</em> 申明</h3>
	<div class="spacing"></div>
	<h4><em>By: Bin4xin.</em></h4>
	<h4>转载请申明本文链接：<a href="/help/CTF-Code-Audit-WalkThrough/" target="_blank"><code-index-css>《<em>Ctf Code Audit Walkthrough</em>》</code-index-css></a></h4>

	<h3><em># Any Questions</em></h3>
	<div class="spacing"></div>
	<h4> >_ 对本文进行提问：<a href="https://github.com/Bin4xin/bin4xin.github.io/issues/new?permalink=https://github.com/Bin4xin/bin4xin.github.io/blob/1b4fffa6232dc6ffa2cece8be0d6c39e0c5f9cfe/help/CTF-Code-Audit-WalkThrough/index.html%23L84" target="_blank"> <em><li class="fa fa-github"></li> Reference in new issue.</em></a></h4>

	<h4> >_ 对本文进行留言：<a href="https://github.com/Bin4xin/bin4xin.github.io/issues/new?permalink=https://about.sentrylab.cn/help/CTF-Code-Audit-WalkThrough/" target="_blank"> <em><li class="fa fa-github"></li> Leave a Comment.</em></a></h4>
</div>
			</div><!-- help content -->
	  </div>
	</div><!--/container -->
</div><!--/mirrors -->
	


<div id="footerwrap" class="tuna-foot-1">
<div class="container">
    <div class="row">
            <div class="col-sm-4">
                <div class="col-sm-6">
                  <p class="thuhidden"><strong>入门</strong></p>
                  <p class="thuhidden"><a href="https://github.com/tuna/mirror-web" target="blank"><em>Jekyll</em>源码</a></p>
                  <p class="thuhidden"><a href="https://www.sentrylab.cn/blog/2019/jekyll/in/linux/" target="blank">博客搭建教程</a></p>
                  <p class="thuhidden"><a href="https://about.sentrylab.cn/news/sentry-lab-markdown-usage/" target="blank">个性化语法批注</a></p>
                  <p class="thuhidden"><a href="https://www.sentrylab.cn/blog/2019/nginx/with/jekyll-site/" target="blank">公网部署</a></p>
                  </div>

                  <div class="col-sm-6">
                  <p class="thuhidden"><strong>社区</strong></p>
                  <p class="thuhidden"><a href="/blog" target="blank">博客</a></p>
                  <p class="thuhidden"><a href="https://github.com/Bin4xin/bigger-than-bigger/tree/master/CoVV" target="blank"><em>Collection of verified vulnerabilities</em></a></p>
                  <p class="thuhidden"><a href="https://github.com/Bin4xin/bigger-than-bigger" target="blank"><em>Bigger than Bigger</em></a></p>
                  <p class="thuhidden"><a href="https://github.com/Bin4xin/B4xinSynchronize" target="blank"><em>B4xinSynchronize</em></a></p>
                  </div>
            </div>

            <div class="col-sm-4">
                  <div class="col-sm-6">
                    <p class="thuhidden"><strong>开发</strong></p>
                    <p class="thuhidden"><a href="https://github.com/Bin4xin/Bin4xin" target="blank"><em>Bin4xin</em></a></p>
                    <p class="thuhidden"><a href="https://www.cloudflare.com/waf/" target="blank"><em>CloudFlare WAF</em></a></p>
                    <p class="thuhidden"><a href="https://jekyllrb.com/docs/" target="blank"><em>Jekyll</em></a></p>
                    <p class="thuhidden"><a href="https://www.markdownguide.org/" target="blank"><em>MarkDown</em></a></p>
                    <p class="share">
                    <a href="https://github.com/Bin4xin/" target="blank"><i class="fa fa-github"></i></a>
                    <a href="https://twitter.com/Bin4xin/"><i class="fa fa-twitter" target="blank"></i></a>
                    <a href="#"><i class="fa fa-facebook" target="blank"></i></a>
                    </p>
                  </div>

                  <div class="col-sm-6">
                    <p class="thuhidden"><strong>关于</strong></p>
                    <p class="thuhidden"><a href="https://about.sentrylab.cn/" target="blank">近期研究</a></p>
                    <p class="thuhidden">∑ <csmall>(Visitors/times)</csmall></em></p>
                    <img src="https://profile-counter.glitch.me/bin4xin.github.io/count.svg" style="max-width:100%;">
                  </div>
            </div>

        <div class="col-sm-4">
          
          <img src="/static/img/logo-small@3x.png" />

        </div>
    </div><!--/row -->
    
    <p class="thuhidden">© 2019-2021 SentrySec, Lab. Build by Jekyll under the terms of the MIT License.</p>

  </div>
</div>




<div id="footerwrap" class="tuna-foot-2">
<div class="container">
    <div class="row">
            <div class="col-sm-4">
                <div class="col-sm-6">
                  <p class="thuhidden"><strong>入门</strong></p>
                  <p class="thuhidden"><a href="https://github.com/tuna/mirror-web" target="blank"><em>Jekyll</em>源码</a></p>
                  <p class="thuhidden"><a href="https://www.sentrylab.cn/blog/2019/jekyll/in/linux/" target="blank">博客搭建教程</a></p>
                  <p class="thuhidden"><a href="https://about.sentrylab.cn/news/sentry-lab-markdown-usage/" target="blank">个性化语法批注</a></p>
                  <p class="thuhidden"><a href="https://www.sentrylab.cn/blog/2019/nginx/with/jekyll-site/" target="blank">公网部署</a></p>
                  </div>

                  <div class="col-sm-6">
                  <p class="thuhidden"><strong>社区</strong></p>
                  <p class="thuhidden"><a href="/blog" target="blank">博客</a></p>
                  <p class="thuhidden"><a href="https://github.com/Bin4xin/bigger-than-bigger/tree/master/CoVV" target="blank"><em>Collection of verified vulnerabilities</em></a></p>
                  <p class="thuhidden"><a href="https://github.com/Bin4xin/bigger-than-bigger" target="blank"><em>Bigger than Bigger</em></a></p>
                  <p class="thuhidden"><a href="https://github.com/Bin4xin/B4xinSynchronize" target="blank"><em>B4xinSynchronize</em></a></p>
                  </div>
            </div>

            <div class="col-sm-4">
                  <div class="col-sm-6">
                    <p class="thuhidden"><strong>开发</strong></p>
                    <p class="thuhidden"><a href="https://github.com/Bin4xin/Bin4xin" target="blank"><em>Bin4xin</em></a></p>
                    <p class="thuhidden"><a href="https://www.cloudflare.com/waf/" target="blank"><em>CloudFlare WAF</em></a></p>
                    <p class="thuhidden"><a href="https://jekyllrb.com/docs/" target="blank"><em>Jekyll</em></a></p>
                    <p class="thuhidden"><a href="https://www.markdownguide.org/" target="blank"><em>MarkDown</em></a></p>
                    <p class="share">
                    <a href="https://github.com/Bin4xin/" target="blank"><i class="fa fa-github"></i></a>
                    <a href="https://twitter.com/Bin4xin/"><i class="fa fa-twitter" target="blank"></i></a>
                    <a href="#"><i class="fa fa-facebook" target="blank"></i></a>
                    </p>
                  </div>

                  <div class="col-sm-6">
                    <p class="thuhidden"><strong>关于</strong></p>
                    <p class="thuhidden"><a href="https://about.sentrylab.cn/" target="blank">近期研究</a></p>
                    <p class="thuhidden">∑ <csmall>(Visitors/times)</csmall></em></p>
                    <img src="https://profile-counter.glitch.me/bin4xin.github.io/count.svg" style="max-width:100%;">
                  </div>
            </div>

        <div class="col-sm-4">
          
          <img src="/static/img/logo-small@3x.png" />

        </div>
    </div><!--/row -->
    
    <p class="thuhidden">© 2019-2021 SentrySec, Lab. Build by Jekyll under the terms of the MIT License.</p>

  </div>
</div>


</body>

<script src="/static/js/help.js"></script>
</html>
<!--
vim: ts=2 sts=2 sw=2 noexpandtab
-->
